---
output:
  html_document:
    theme: flatly
    css: styles.css
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
library(tidyverse) ; library(scales) ; library(ggsci) ; library(sf) ; library(ggrepel)

theme_x <- function () { 
  theme_minimal(base_size = 14, base_family = "Open Sans") %+replace% 
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      plot.title = element_text(size = 16, face = "bold", hjust = 0),
      plot.subtitle = element_text(hjust = 0, margin = margin(9, 0, 9, 0)),
      plot.caption = element_text(color = "grey50", hjust = 1, margin = margin(t = 15)),
      axis.title = element_text(size = 10, hjust = 1),
      axis.text.x = element_text(angle = 90, hjust = 1, margin = margin(t = 0)),
      legend.position = "top", 
      legend.justification = "left"
    )
}

la <- st_read("data/geospatial/trafford_local_authority_generalised.geojson", quiet = TRUE)
```

Climate emergency datakit
================

**More than half of UK councils have declared a 'climate emergency'. This datakit is designed to help councils address this emergency by making open data relating to climate change more discoverable.**

**A variety of open datasets are presented with metadata and example visualisations. Structured data that has been pre-processed by the <a href="https://www.trafforddatalab.io/" target="_blank">Trafford Data Lab</a> are provided at local authority level where available.**

## Carbon emissions

### CO<sub>2</sub> emissions by sector

Estimated CO<sub>2</sub> emissions at local authority level are published by the <a href="https://www.gov.uk/government/collections/uk-local-authority-and-regional-carbon-dioxide-emissions-national-statistics" target="_blank">Department for Business, Energy & Industrial Strategy</a> (BEIS). The data derive from the UK <a href="http://naei.defra.gov.uk/" target="_blank">National Atmospheric Emissions Inventory</a> and BEIS’s National Statistics of energy consumption for local authority areas. The data can help councils to identify sectors that are emitting high levels of CO<sub>2</sub> and monitor these levels over time. CO<sub>2</sub> emissions are measured in kilotonnes and broken down by different domestic, industrial and transport sectors e.g. Agricultural Combustion, Domestic Gas, Land Use Change and Forestry (LULUCF), and Road Transport (Motorways). Emissions from aviation, shipping and military transport are not included.

<div class = "metadata">
|Indicator |Period |Geography |Source |Updated |Licence |Data |
|---|---|---|---|---|---|---|
|CO<sub>2</sub> emissions |2005-2017 |Local authority |<a href="https://www.gov.uk/government/statistics/uk-local-authority-and-regional-carbon-dioxide-emissions-national-statistics-2005-to-2017" target="_blank">BEIS</a> | 2019-06-27 |<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank">OGL v3.0</a> |<a href="data/co2_emissions.csv" target="_blank">view</a> |
</div>

```{r fig.retina = 3}
co2_emissions <- read_csv("data/co2_emissions.csv") %>% 
  filter(area_name == "Trafford",
         group %in% c("Domestic total", "Industry and commercial total", "Transport total"))

ggplot(data = co2_emissions, 
       aes(x = period, y = value, fill = group)) +
  geom_col(position = "stack") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_y_continuous(labels = comma, expand = c(0.005, 0.005)) +
  scale_fill_viridis_d(direction = -1,
                       labels = c("Domestic total" = "Domestic", 
                                  "Industry and commercial total" = "Industry and commercial", 
                                  "Transport total" = "Transport")) +
  labs(x = NULL, 
       y = expression(paste(CO[2], " (kt)")),
       title = "Carbon dioxide emissions by sector",
       subtitle = paste0(distinct(co2_emissions, area_name), ", 2005-2017"),
       caption = "Source: BEIS",
       fill = NULL) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_x()
```

**Additional resources**    
The National Atmospheric Emissions Inventory (NAEI) website has an <a href="https://naei.beis.gov.uk/laco2app" target="_blank">interactive map</a> that allows you to explore CO<sub>2</sub> emissions by local authority area and sector.

***

### CO<sub>2</sub> emissions from large 'point sources'

The <a href="http://naei.defra.gov.uk/" target="_blank">National Atmospheric Emissions Inventory</a> define <a href="https://naei.beis.gov.uk/data/map-large-source" target="_blank">'point sources'</a> as industrial and commercial emission sites that have a known location. The NAEI dataset includes a number of pollutants such as methane and other greenhouse gases. 

<div class = "metadata">
|Indicator |Period |Geography |Source |Updated |Licence |Data |
|---|---|---|---|---|---|---|
|CO<sub>2</sub> emissions from large 'point sources' |2016 |Point locations |<a href="https://naei.beis.gov.uk/data/map-large-source" target="_blank">NAEI</a> | 2018-09-27 |<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank">OGL v3.0</a> |<a href="data/large_point_sources.csv" target="_blank">view</a> |
</div>

```{r fig.retina = 3}
large_point_sources <- read_csv("data/large_point_sources.csv") %>% 
  mutate(value = round(value,0)) %>% 
  filter(area_name == "Trafford")

ggplot(large_point_sources, aes(lon, lat)) + 
  geom_sf(data = la, fill = NA, color = "#212121", size = 0.5) +
  geom_point(aes(size = value, alpha = value), fill = "#212121", shape = 21) +
  geom_text_repel(data = filter(large_point_sources, site == "Carrington CCGT"),
                  aes(x = lon, y = lat, 
                      label = paste0(site, "\n", comma(value), " tonnes")),
                  nudge_x = -0.2, nudge_y = 0.03) +
  scale_alpha_continuous(guide = "legend", label = comma, breaks = pretty_breaks(5)) +
  scale_size_continuous(label = comma, range = c(2, 12), breaks = pretty_breaks(5)) +
  labs(x = NULL, y = NULL, size = "Tonnes", alpha = "Tonnes",
       title = expression(bold(paste(CO[2], " emissions from large sites"))),
       subtitle = paste0(distinct(large_point_sources, area_name), ", 2016")) +
  coord_sf(datum = NA) +
  theme_x() +
  theme(legend.title = element_text(size = 10),
        legend.text = element_text(size = 8)) 
```

## Fuel consumption

### Road transport fuel consumption
<a href="https://www.gov.uk/government/collections/road-transport-consumption-at-regional-and-local-level" target="_blank">BEIS</a> publish data on road  transport fuel  use at local authority level as part of <a href="http://naei.defra.gov.uk/" target="_blank">National Atmospheric Emissions Inventory</a> work. Estimates are available for petrol (petrol cars, motorcycles and petrol LGVs) and diesel (diesel  cars, diesel LGVs, HGVs and buses) consuming vehicles. Estimates by road type (motorways, A roads and minor roads) is also available in the source dataset.

<div class = "metadata">
|Indicator |Period |Geography |Source |Updated |Licence |Data |
|---|---|---|---|---|---|---|
|Road transport energy consumption |2005-2017 |Local authority |<a href="https://www.gov.uk/government/statistical-data-sets/road-transport-energy-consumption-at-regional-and-local-authority-level" target="_blank">BEIS</a> | 2019-06-27 |<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank">OGL v3.0</a> |<a href="data/road_transport_energy_consumption.csv" target="_blank">view</a> |
</div>

```{r fig.retina = 3}
road_transport_fuel_consumption <- read_csv("data/road_transport_fuel_consumption.csv") %>% 
  filter(area_name == "Trafford")

ggplot(road_transport_fuel_consumption, 
       aes(x = period, y = value, colour = group)) +
  geom_line(size = 1) +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_y_continuous(labels = comma,
                     expand = c(0.005, 0.005)) +
  scale_color_uchicago() +
  labs(x = NULL, 
       y = "tonnes of oil",
       title = "Fuel use by vehicle type",
       subtitle = paste0(distinct(road_transport_fuel_consumption, area_name), ", 2005-2017"),
       caption = "Source: BEIS",
       colour = NULL) +
  theme_x()
```

**Additional resources**    
The methodology for calculating road transport fuel consumption is available <a href="https://www.gov.uk/government/publications/regional-energy-data-guidance-note" target="_blank">BEIS website</a>.

***

### Residual fuel consumption

Residual fuels include manufactured solid fuels, renewables, petroleum and coal that are not used for the generation of electricity or road transport.

<div class = "metadata">
|Indicator |Period |Geography |Source |Updated |Licence |Data |
|---|---|---|---|---|---|---|
|Residual fuel consumption |2005-2016 |Local authority |<a href="https://www.gov.uk/government/statistical-data-sets/estimates-of-non-gas-non-electricity-and-non-road-transport-fuels-at-regional-and-local-authority-level" target="_blank">BEIS</a> | 2018-09-27 |<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank">OGL v3.0</a> |<a href="data/residual_fuel_consumption.csv" target="_blank">view</a> |
</div>

```{r fig.retina = 3}
residual_fuel_consumption <- read_csv("data/residual_fuel_consumption.csv") %>% 
  filter(area_name == "Trafford",  group != "Total")

ggplot(data = residual_fuel_consumption, aes(x = period, y = value, fill = group)) +
  geom_col(position = "stack") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_y_continuous(labels = comma,
                     expand = c(0.005, 0.005)) +
  scale_fill_simpsons() +
  labs(x = NULL, 
       y = "thousand tonnes of oil",
       title = "Residual fuel consumption",
       subtitle = paste0(distinct(residual_fuel_consumption, area_name), ", 2005-2016"),
       caption = "Source: BEIS",
       fill = NULL) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_x()
```

## Air pollution

### Background 
The <a href="https://www.gov.uk/government/organisations/department-for-environment-food-rural-affairs" target="_blank">Department for Environment Food & Rural Affairs</a> (DEFRA) publish estimates for annual mean background concentrations of NOx, nitrogen dioxide (NO<sub>2</sub>), coarse (PM<sub>10</sub>) and fine particulate matter (PM<sub>2.5</sub>). Data for 2017 are available at local authority level by 1 km x 1 km grid square centroids. 

<a href="https://cran.r-project.org/" target="_blank">R</a> users can adapt the code to create 1 km x 1 km grid squares for their local authority to map background concentrations against. 

<div class = "metadata">
|Indicator |Period |Geography |Source |Updated |Licence |Code |
|---|---|---|---|---|---|---|
|Background air pollution |2017 |1 km x 1 km grid square centroids |<a href="https://uk-air.defra.gov.uk/data/laqm-background-maps?year=2017" target="_blank">DEFRA</a> | 2018-09-27 |<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank">OGL v3.0</a> |<a href="code/background_air_pollution.R" target="_blank">view</a> |
</div>

```{r fig.retina = 3}
background_air_pollution <- st_read("data/background_air_pollution.geojson", quiet = TRUE)

ggplot(data = background_air_pollution, 
       aes(fill = value, color = value)) +
  geom_sf(data = la, fill = NA, color = "#212121", size = 0.5) +
  geom_sf(color = NA, alpha = 0.8) +
  scale_fill_viridis_c(direction = -1,
                       guide = guide_colorbar(
                         barheight = unit(2, units = "mm"),
                         barwidth = unit(50, units = "mm"),
                         title.position = "left",
                         title.vjust = 1,
                         label.hjust = 0.5
                       )) +
  labs(title = expression(bold(paste("Modelled background ", PM[2.5], " concentrations"))),
       subtitle = "Trafford, 2017",
       fill = "Annual mean (μg/m3)") +
  coord_sf(datum = NA) +
  theme_x() +
  theme(legend.title = element_text(size = 10),
        legend.text = element_text(size = 8)) 
```


**Additional resources**    
The <a href="https://uk-air.defra.gov.uk/data/gis-mapping" target="_blank">UK Ambient Air Quality Interactive Map</a> visualises the background concentration data.

***

### Roadside

## Domestic properties

### Domestic property build period
Information about the age of domestic dwellings is available from the <a href="https://www.gov.uk/government/organisations/valuation-office-agency" target="_blank">Valuation Office Agency</a>. The age of a building influences energy consumption with older properties tending to be less energy efficient than newer buildings.

<div class = "metadata">
|Indicator |Period |Geography |Source |Updated |Licence |Data |
|---|---|---|---|---|---|---|
|Domestic property build period |pre-1900 to 2018 |Local authority |<a href="https://www.gov.uk/government/statistics/council-tax-stock-of-properties-2018" target="_blank">VOA</a> | 2018-11-29 |<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank">OGL v3.0</a> |<a href="data/domestic_property_build_period.csv" target="_blank">view</a> |
</div>

```{r fig.retina = 3}
domestic_property_build_period <- read_csv("data/domestic_property_build_period.csv") %>% 
  filter(area_name == "Trafford") %>% 
  mutate(group = as.factor(group),
         group = fct_relevel(group, "pre-1900"))

ggplot(domestic_property_build_period, 
         aes(x = factor(group), y = value)) +
  geom_col(fill = "brown4") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_y_continuous(labels = comma) +
  labs(x = NULL, 
       y = "Dwellings",
       title = "Age of domestic dwellings",
       subtitle = paste0(distinct(domestic_property_build_period, area_name), ", 2018"),
       caption = "Source: Valuation Office Agency")  +
  theme_x()
```

***

### EPCs by Environmental Impact Rating 
An Energy Performance Certificate's Environmental Impact Rating is an estimate of the amount of CO<sub>2</sub> produced by homes. The most energy efficient homes fall within band A (lowest CO<sub>2</sub> emissions) and the least efficent in Band G (highest CO<sub>2</sub> emissions). Lodgements are published on a quarterly basis

The number of EPCs lodged on the Energy Performance of Buildings Register each quarter is published by the <a href="https://www.gov.uk/government/statistical-data-sets/live-tables-on-energy-performance-of-buildings-certificates" target="_blank">Ministry of Housing, Communities & Local Government</a>.

<div class = "metadata">
|Indicator |Period |Geography |Source |Updated |Licence |Data |
|---|---|---|---|---|---|---|
|EPCs by Environmental Impact Rating |2009-2018 |Local authority |<a href="https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/821971/D2_-_Domestic_EPCs.xlsx" target="_blank">MHCLG</a> | 2019-07-31 |<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank">OGL v3.0</a> |<a href="data/domestic_epcs.csv" target="_blank">view</a> |
</div>

```{r fig.retina = 3}
domestic_epcs <- read_csv("data/domestic_epcs.csv") %>% 
  filter(area_name == "Trafford") %>% 
  group_by(area_name, group) %>% 
  summarise(value = sum(value)) %>% 
  mutate(value = value / sum(value))

ggplot(domestic_epcs, aes(x = group, y = value)) +
  geom_col(fill = "#1380A1") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_y_continuous(labels = percent_format(1), expand = c(0.005, 0.005)) +
  labs(x = NULL, 
       y = "Lodgements",
       title = "Cumulative domestic Energy Performance Certificates\nby Environmental Impact Rating",
       subtitle = paste0(distinct(domestic_epcs, area_name), ", 2009-2018"),
       caption = "Source: MHCLG") +
  theme_x() +
  theme(axis.text.x = element_text(angle = 0))
```

